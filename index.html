<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é »å°¿æ—¥è¨˜</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Hiragino Kaku Gothic ProN", "Yu Gothic", sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .date-display {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            color: #666;
            font-size: 16px;
            cursor: pointer;
            position: relative;
            transition: all 0.3s;
        }

        .tab.active {
            color: #667eea;
            font-weight: bold;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        select, input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #667eea;
        }

        .amount-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .amount-btn {
            padding: 15px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .amount-btn:hover {
            background: #f5f5f5;
        }

        .amount-btn.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .add-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            transition: transform 0.2s;
        }

        .add-btn:active {
            transform: scale(0.98);
        }

        .record-item {
            background: #f8f9ff;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .record-info {
            flex: 1;
        }

        .record-time {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .record-details {
            color: #666;
            font-size: 14px;
        }

        .delete-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .summary {
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .summary-item {
            text-align: center;
        }

        .summary-value {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .summary-label {
            color: #666;
            font-size: 14px;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .custom-amount {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 10px;
        }

        .custom-amount input {
            flex: 1;
        }

        .custom-amount button {
            padding: 12px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        .night-mode-toggle {
            background: none;
            border: 2px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .night-mode-toggle:hover {
            background: #667eea;
            transform: scale(1.1);
        }

        body.night-mode {
            background: linear-gradient(135deg, #000000 0%, #0a0000 100%);
            filter: brightness(0.6);
        }

        body.night-mode .container {
            background: #050505;
            color: #5a2020;
        }

        body.night-mode h1 {
            color: #5a2020;
        }

        body.night-mode .date-display {
            color: #4a1818;
        }

        body.night-mode .tab {
            color: #4a1818;
            border-bottom-color: #1a1a1a;
        }

        body.night-mode .tab.active {
            color: #5a2020;
        }

        body.night-mode .tab.active::after {
            background: #4a1818;
        }

        body.night-mode label {
            color: #4a1818;
        }

        body.night-mode select,
        body.night-mode input {
            background: #0a0a0a;
            border-color: #1a1a1a;
            color: #4a1818;
        }

        body.night-mode .amount-btn {
            background: #0a0a0a;
            border-color: #1a1a1a;
            color: #4a1818;
        }

        body.night-mode .amount-btn:hover {
            background: #1a1a1a;
        }

        body.night-mode .amount-btn.selected {
            background: #2a0a0a;
            border-color: #2a0a0a;
            color: #000000;
        }

        body.night-mode .add-btn {
            background: linear-gradient(135deg, #2a0a0a 0%, #3a0f0f 100%);
            color: #000000;
        }

        body.night-mode .record-item {
            background: #0a0a0a;
        }

        body.night-mode .record-time {
            color: #5a2020;
        }

        body.night-mode .record-details {
            color: #4a1818;
        }

        body.night-mode .delete-btn {
            background: #2a0808;
            color: #000000;
        }

        body.night-mode .summary {
            background: linear-gradient(135deg, #0a0202 0%, #150505 100%);
        }

        body.night-mode .summary-value {
            color: #5a2020;
        }

        body.night-mode .summary-label {
            color: #4a1818;
        }

        body.night-mode .empty-state {
            color: #3a3a3a;
        }

        body.night-mode .custom-amount button {
            background: #2a0a0a;
            color: #000000;
        }

        body.night-mode .night-mode-toggle {
            border-color: #4a1818;
            color: #4a1818;
        }

        body.night-mode .night-mode-toggle:hover {
            background: #2a0a0a;
        }

        body.night-mode a {
            color: #4a1818;
        }
    </style>
</head>
<body>
    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <div>
                <h1>ğŸ’§ é »å°¿æ—¥è¨˜</h1>
                <div class="date-display" id="dateDisplay"></div>
            </div>
            <button class="night-mode-toggle" onclick="toggleNightMode()" id="nightModeBtn">
                ğŸŒ™
            </button>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('urination')">æ’å°¿</button>
            <button class="tab" onclick="switchTab('intake')">æ°´åˆ†æ‘‚å–</button>
            <button class="tab" onclick="switchTab('history')">è¨˜éŒ²</button>
        </div>

        <!-- æ’å°¿ã‚¿ãƒ– -->
        <div id="urination" class="tab-content active">
            <div class="input-group">
                <label>é‡</label>
                <div class="amount-selector">
                    <button class="amount-btn" onclick="selectUrinationAmount('ãƒãƒ§ãƒ­ãƒãƒ§ãƒ­')">ãƒãƒ§ãƒ­ãƒãƒ§ãƒ­</button>
                    <button class="amount-btn" onclick="selectUrinationAmount('æ™®é€š')">æ™®é€š</button>
                    <button class="amount-btn" onclick="selectUrinationAmount('å¤§é‡')">å¤§é‡</button>
                </div>
                <div class="custom-amount">
                    <input type="text" id="customUrinationAmount" placeholder="ãã®ä»–ã‚’å…¥åŠ›">
                    <button onclick="selectCustomUrinationAmount()">è¨­å®š</button>
                </div>
            </div>

            <div class="input-group">
                <label>ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
                <input type="text" id="urinationNote" placeholder="ä¾‹ï¼šå¤œé–“ã€æˆ‘æ…¢ã§ããªã‹ã£ãŸç­‰">
            </div>

            <button class="add-btn" onclick="addUrination()">ğŸš½ æ’å°¿ã‚’è¨˜éŒ²</button>
        </div>

        <!-- æ°´åˆ†æ‘‚å–ã‚¿ãƒ– -->
        <div id="intake" class="tab-content">
            <div class="input-group">
                <label>é£²ã¿ç‰©ã®ç¨®é¡</label>
                <select id="drinkType">
                    <option value="æ°´">æ°´</option>
                    <option value="ãŠèŒ¶">ãŠèŒ¶</option>
                    <option value="ã‚³ãƒ¼ãƒ’ãƒ¼">ã‚³ãƒ¼ãƒ’ãƒ¼</option>
                    <option value="ç´…èŒ¶">ç´…èŒ¶</option>
                    <option value="ã‚¸ãƒ¥ãƒ¼ã‚¹">ã‚¸ãƒ¥ãƒ¼ã‚¹</option>
                    <option value="ç‰›ä¹³">ç‰›ä¹³</option>
                    <option value="ã‚¹ãƒãƒ¼ãƒ„ãƒ‰ãƒªãƒ³ã‚¯">ã‚¹ãƒãƒ¼ãƒ„ãƒ‰ãƒªãƒ³ã‚¯</option>
                    <option value="ãã®ä»–">ãã®ä»–</option>
                </select>
            </div>

            <div class="input-group">
                <label>é‡ï¼ˆmlï¼‰</label>
                <div class="amount-selector">
                    <button class="amount-btn" onclick="selectAmount(100)">100ml</button>
                    <button class="amount-btn" onclick="selectAmount(150)">150ml</button>
                    <button class="amount-btn" onclick="selectAmount(200)">200ml</button>
                    <button class="amount-btn" onclick="selectAmount(250)">250ml</button>
                    <button class="amount-btn" onclick="selectAmount(300)">300ml</button>
                    <button class="amount-btn" onclick="selectAmount(500)">500ml</button>
                </div>
                <div class="custom-amount">
                    <input type="number" id="customAmount" placeholder="ã‚«ã‚¹ã‚¿ãƒ é‡ã‚’å…¥åŠ›">
                    <button onclick="selectCustomAmount()">è¨­å®š</button>
                </div>
            </div>

            <button class="add-btn" onclick="addIntake()">ğŸ’§ æ°´åˆ†æ‘‚å–ã‚’è¨˜éŒ²</button>
        </div>

        <!-- è¨˜éŒ²ã‚¿ãƒ– -->
        <div id="history" class="tab-content">
            <div class="summary">
                <div class="summary-grid">
                    <div class="summary-item">
                        <div class="summary-value" id="totalIntake">0</div>
                        <div class="summary-label">ç·æ°´åˆ†é‡ï¼ˆmlï¼‰</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value" id="totalUrination">0</div>
                        <div class="summary-label">æ’å°¿å›æ•°</div>
                    </div>
                </div>
            </div>

            <div class="input-group">
                <label>ğŸ“Š Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆè¨­å®š</label>
                <input type="text" id="sheetUrl" placeholder="Apps Scriptã®ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªURLã‚’å…¥åŠ›" style="margin-bottom: 10px;">
                <button class="add-btn" onclick="saveSheetUrl()" style="margin-top: 0; padding: 12px;">è¨­å®šã‚’ä¿å­˜</button>
                <div style="font-size: 12px; color: #666; margin-top: 10px; line-height: 1.6;">
                    ğŸ’¡ è¨˜éŒ²ã™ã‚‹åº¦ã«ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ä¿å­˜ã•ã‚Œã¾ã™<br>
                    ğŸ•› æ¯æ—¥24æ™‚ã«è¨˜éŒ²ã‚¿ãƒ–ã®å†…å®¹ã¯ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™<br>
                    âš™ï¸ <a href="#" onclick="showSheetSetup(); return false;" style="color: #667eea;">è¨­å®šæ‰‹é †ã‚’è¦‹ã‚‹</a> | 
                    <a href="#" onclick="testConnection(); return false;" style="color: #667eea;">æ¥ç¶šãƒ†ã‚¹ãƒˆ</a> |
                    <a href="#" onclick="manualExport(); return false;" style="color: #667eea;">ä»Šã™ãå…¨ä»¶ä¿å­˜</a>
                </div>
            </div>

            <div id="recordsList"></div>
        </div>
    </div>

    <script>
        let selectedAmount = null;
        let selectedUrinationAmount = null;
        let records = JSON.parse(localStorage.getItem('bladderDiary')) || [];
        let sheetUrl = localStorage.getItem('sheetUrl') || '';

        // æ—¥ä»˜è¡¨ç¤º
        function updateDate() {
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
            document.getElementById('dateDisplay').textContent = now.toLocaleDateString('ja-JP', options);
        }

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');

            if (tabName === 'history') {
                updateHistory();
                document.getElementById('sheetUrl').value = sheetUrl;
            }
        }

        // æ°´åˆ†é‡é¸æŠ
        function selectAmount(amount) {
            selectedAmount = amount;
            document.querySelectorAll('#intake .amount-btn').forEach(btn => btn.classList.remove('selected'));
            event.target.classList.add('selected');
        }

        function selectCustomAmount() {
            const customAmount = parseInt(document.getElementById('customAmount').value);
            if (customAmount > 0) {
                selectedAmount = customAmount;
                document.querySelectorAll('#intake .amount-btn').forEach(btn => btn.classList.remove('selected'));
            }
        }

        // æ’å°¿é‡é¸æŠ
        function selectUrinationAmount(amount) {
            selectedUrinationAmount = amount;
            document.querySelectorAll('#urination .amount-btn').forEach(btn => btn.classList.remove('selected'));
            event.target.classList.add('selected');
        }

        function selectCustomUrinationAmount() {
            const customAmount = document.getElementById('customUrinationAmount').value.trim();
            if (customAmount) {
                selectedUrinationAmount = customAmount;
                document.querySelectorAll('#urination .amount-btn').forEach(btn => btn.classList.remove('selected'));
            }
        }

        // æ°´åˆ†æ‘‚å–è¨˜éŒ²
        async function addIntake() {
            const drinkType = document.getElementById('drinkType').value;
            
            if (!selectedAmount) {
                alert('é‡ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            const record = {
                type: 'intake',
                timestamp: new Date().toISOString(),
                drinkType: drinkType,
                amount: selectedAmount
            };

            records.push(record);
            saveRecords();
            
            // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ä¿å­˜
            if (sheetUrl) {
                await saveRecordToSheet(record);
            }
            
            // ãƒªã‚»ãƒƒãƒˆ
            selectedAmount = null;
            document.querySelectorAll('#intake .amount-btn').forEach(btn => btn.classList.remove('selected'));
            document.getElementById('customAmount').value = '';
            
            alert('âœ… è¨˜éŒ²ã—ã¾ã—ãŸï¼');
        }

        // æ’å°¿è¨˜éŒ²
        async function addUrination() {
            if (!selectedUrinationAmount) {
                alert('é‡ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            const note = document.getElementById('urinationNote').value;

            const record = {
                type: 'urination',
                timestamp: new Date().toISOString(),
                amount: selectedUrinationAmount,
                note: note
            };

            records.push(record);
            saveRecords();
            
            // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ä¿å­˜
            if (sheetUrl) {
                await saveRecordToSheet(record);
            }
            
            // ãƒªã‚»ãƒƒãƒˆ
            selectedUrinationAmount = null;
            document.querySelectorAll('#urination .amount-btn').forEach(btn => btn.classList.remove('selected'));
            document.getElementById('customUrinationAmount').value = '';
            document.getElementById('urinationNote').value = '';
            
            alert('âœ… è¨˜éŒ²ã—ã¾ã—ãŸï¼');
        }

        // è¨˜éŒ²ä¿å­˜
        function saveRecords() {
            localStorage.setItem('bladderDiary', JSON.stringify(records));
        }

        // è¨˜éŒ²å‰Šé™¤
        function deleteRecord(index) {
            if (confirm('ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                records.splice(index, 1);
                saveRecords();
                updateHistory();
            }
        }

        // å±¥æ­´æ›´æ–°
        function updateHistory() {
            const today = new Date().toDateString();
            const todayRecords = records.filter(r => 
                new Date(r.timestamp).toDateString() === today
            );

            // çµ±è¨ˆè¨ˆç®—
            const totalIntake = todayRecords
                .filter(r => r.type === 'intake')
                .reduce((sum, r) => sum + r.amount, 0);
            
            const totalUrination = todayRecords.filter(r => r.type === 'urination').length;

            document.getElementById('totalIntake').textContent = totalIntake;
            document.getElementById('totalUrination').textContent = totalUrination;

            // è¨˜éŒ²ä¸€è¦§
            const recordsList = document.getElementById('recordsList');
            
            if (todayRecords.length === 0) {
                recordsList.innerHTML = '<div class="empty-state">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }

            // æ™‚ç³»åˆ—ã§é™é †ã‚½ãƒ¼ãƒˆ
            todayRecords.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            recordsList.innerHTML = todayRecords.map((record, index) => {
                const time = new Date(record.timestamp).toLocaleTimeString('ja-JP', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });

                if (record.type === 'intake') {
                    return `
                        <div class="record-item">
                            <div class="record-info">
                                <div class="record-time">ğŸ’§ ${time}</div>
                                <div class="record-details">${record.drinkType} - ${record.amount}ml</div>
                            </div>
                            <button class="delete-btn" onclick="deleteRecord(${records.indexOf(record)})">å‰Šé™¤</button>
                        </div>
                    `;
                } else {
                    return `
                        <div class="record-item">
                            <div class="record-info">
                                <div class="record-time">ğŸš½ ${time}</div>
                                <div class="record-details">${record.amount}${record.note ? ' - ' + record.note : ''}</div>
                            </div>
                            <button class="delete-btn" onclick="deleteRecord(${records.indexOf(record)})">å‰Šé™¤</button>
                        </div>
                    `;
                }
            }).join('');
        }

        // Google Sheets URLä¿å­˜
        function saveSheetUrl() {
            const url = document.getElementById('sheetUrl').value.trim();
            if (!url) {
                alert('Apps Scriptã®ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªURLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            // Apps Script URLã‹ãƒã‚§ãƒƒã‚¯
            if (!url.includes('script.google.com/macros/s/') || !url.endsWith('/exec')) {
                alert('æœ‰åŠ¹ãªApps Scriptã®ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªURLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„\n\nä¾‹ï¼šhttps://script.google.com/macros/s/.../exec');
                return;
            }
            
            sheetUrl = url;
            localStorage.setItem('sheetUrl', sheetUrl);
            alert('âœ… è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸï¼æ¯æ—¥24æ™‚ã«è‡ªå‹•ä¿å­˜ã•ã‚Œã¾ã™ã€‚');
        }

        // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆè¨­å®šæ‰‹é †ã‚’è¡¨ç¤º
        function showSheetSetup() {
            const instructions = `ğŸ“Š Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆè¨­å®šæ‰‹é †

ã€ã‚¹ãƒ†ãƒƒãƒ—1ã€‘Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ä½œæˆ
1. æ–°ã—ã„Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ä½œæˆ
2. 1è¡Œç›®ã«ä»¥ä¸‹ã®è¦‹å‡ºã—ã‚’å…¥åŠ›ï¼š
   A1: æ—¥ä»˜
   B1: æ™‚åˆ»
   C1: ç¨®é¡
   D1: å†…å®¹
   E1: é‡(ml)
   F1: ãƒ¡ãƒ¢

ã€ã‚¹ãƒ†ãƒƒãƒ—2ã€‘Apps Scriptã‚’è¨­å®š
1. ã€Œæ‹¡å¼µæ©Ÿèƒ½ã€â†’ã€ŒApps Scriptã€ã‚’é–‹ã
2. æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ã‚’å…¨ã¦å‰Šé™¤
3. ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’è²¼ã‚Šä»˜ã‘ï¼š

function doPost(e) {
  try {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
    const data = JSON.parse(e.postData.contents);
    
    // ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
    data.records.forEach(record => {
      sheet.appendRow(record);
    });
    
    return ContentService
      .createTextOutput(JSON.stringify({
        success: true,
        message: 'ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸ'
      }))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    return ContentService
      .createTextOutput(JSON.stringify({
        success: false,
        message: error.toString()
      }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

4. ğŸ’¾ ä¿å­˜ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯

ã€ã‚¹ãƒ†ãƒƒãƒ—3ã€‘ãƒ‡ãƒ—ãƒ­ã‚¤
1. ã€Œãƒ‡ãƒ—ãƒ­ã‚¤ã€â†’ã€Œæ–°ã—ã„ãƒ‡ãƒ—ãƒ­ã‚¤ã€ã‚’ã‚¯ãƒªãƒƒã‚¯
2. æ­¯è»Šã‚¢ã‚¤ã‚³ãƒ³âš™ï¸â†’ã€Œã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã€ã‚’é¸æŠ
3. èª¬æ˜ï¼šã€Œé »å°¿æ—¥è¨˜APIã€ãªã©ï¼ˆä»»æ„ï¼‰
4. æ¬¡ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦å®Ÿè¡Œï¼šã€Œè‡ªåˆ†ã€ã‚’é¸æŠ
5. ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼šã€Œå…¨å“¡ã€ã‚’é¸æŠ
6. ã€Œãƒ‡ãƒ—ãƒ­ã‚¤ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
7. ã€Œã‚¢ã‚¯ã‚»ã‚¹ã‚’æ‰¿èªã€â†’è‡ªåˆ†ã®Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’é¸æŠ
8. ã€Œè©³ç´°ã€â†’ã€Œï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåï¼‰ã«ç§»å‹•ã€ã‚’ã‚¯ãƒªãƒƒã‚¯
9. ã€Œè¨±å¯ã€ã‚’ã‚¯ãƒªãƒƒã‚¯
10. è¡¨ç¤ºã•ã‚ŒãŸã€Œã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªURLã€ã‚’ã‚³ãƒ”ãƒ¼
    ï¼ˆhttps://script.google.com/macros/s/...../execï¼‰

ã€ã‚¹ãƒ†ãƒƒãƒ—4ã€‘ã‚¢ãƒ—ãƒªã«è¨­å®š
1. ã‚³ãƒ”ãƒ¼ã—ãŸURLã‚’ä¸Šã®å…¥åŠ›æ¬„ã«è²¼ã‚Šä»˜ã‘
2. ã€Œè¨­å®šã‚’ä¿å­˜ã€ã‚’ã‚¯ãƒªãƒƒã‚¯
3. ã€Œæ¥ç¶šãƒ†ã‚¹ãƒˆã€ã§å‹•ä½œç¢ºèª

ã“ã‚Œã§è¨˜éŒ²ã™ã‚‹åº¦ã«è‡ªå‹•çš„ã«ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ä¿å­˜ã•ã‚Œã¾ã™ï¼`;

            alert(instructions);
        }

        // æ¥ç¶šãƒ†ã‚¹ãƒˆ
        async function testConnection() {
            if (!sheetUrl) {
                alert('å…ˆã«Apps Scriptã®ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªURLã‚’è¨­å®šã—ã¦ãã ã•ã„');
                return;
            }

            const testData = {
                records: [
                    [
                        new Date().toLocaleDateString('ja-JP'),
                        new Date().toLocaleTimeString('ja-JP'),
                        'ãƒ†ã‚¹ãƒˆ',
                        'æ¥ç¶šç¢ºèª',
                        '',
                        'ã“ã®ãƒ‡ãƒ¼ã‚¿ã¯æ¥ç¶šãƒ†ã‚¹ãƒˆã§ã™'
                    ]
                ]
            };

            try {
                const response = await fetch(sheetUrl, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testData)
                });

                // no-corsãƒ¢ãƒ¼ãƒ‰ã§ã¯è©³ç´°ãªçµæœãŒå–å¾—ã§ããªã„ãŸã‚ã€é€ä¿¡æˆåŠŸã¨ã¿ãªã™
                alert('âœ… æ¥ç¶šãƒ†ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¾ã—ãŸï¼\n\nã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ç¢ºèªã—ã¦ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ãŒè¿½åŠ ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚\n\nãƒ‡ãƒ¼ã‚¿ãŒè¿½åŠ ã•ã‚Œã¦ã„ã‚Œã°è¨­å®šå®Œäº†ã§ã™ï¼');
            } catch (error) {
                alert('âŒ æ¥ç¶šã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n\nURLãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚\n\nã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        }

        // æ‰‹å‹•ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        async function manualExport() {
            if (!sheetUrl) {
                alert('å…ˆã«Apps Scriptã®ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªURLã‚’è¨­å®šã—ã¦ãã ã•ã„');
                return;
            }

            const today = new Date().toDateString();
            const todayRecords = records.filter(r => 
                new Date(r.timestamp).toDateString() === today
            );

            if (todayRecords.length === 0) {
                alert('ä»Šæ—¥ã®è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            // å…¨è¨˜éŒ²ã‚’ã¾ã¨ã‚ã¦é€ä¿¡
            const exportData = todayRecords.map(record => {
                const date = new Date(record.timestamp);
                const dateStr = date.toLocaleDateString('ja-JP');
                const timeStr = date.toLocaleTimeString('ja-JP', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                if (record.type === 'intake') {
                    return [dateStr, timeStr, 'æ°´åˆ†æ‘‚å–', record.drinkType, record.amount, ''];
                } else {
                    return [dateStr, timeStr, 'æ’å°¿', record.amount, '', record.note || ''];
                }
            });

            const payload = { records: exportData };

            try {
                await fetch(sheetUrl, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                alert('âœ… ä»Šæ—¥ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ä¿å­˜ã—ã¾ã—ãŸï¼');
            } catch (error) {
                alert('âŒ ãƒ‡ãƒ¼ã‚¿é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\næ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            }
        }

        // å€‹åˆ¥ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ä¿å­˜
        async function saveRecordToSheet(record) {
            if (!sheetUrl) return false;

            const date = new Date(record.timestamp);
            const dateStr = date.toLocaleDateString('ja-JP');
            const timeStr = date.toLocaleTimeString('ja-JP', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            let rowData;
            if (record.type === 'intake') {
                rowData = [
                    dateStr, 
                    timeStr, 
                    'æ°´åˆ†æ‘‚å–', 
                    record.drinkType, 
                    record.amount, 
                    ''
                ];
            } else {
                rowData = [
                    dateStr, 
                    timeStr, 
                    'æ’å°¿', 
                    record.amount, 
                    '', 
                    record.note || ''
                ];
            }

            const payload = {
                records: [rowData]
            };

            try {
                await fetch(sheetUrl, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                console.log('âœ… ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ä¿å­˜ã—ã¾ã—ãŸ:', timeStr);
                return true;
            } catch (error) {
                console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                return false;
            }
        }

        // 24æ™‚ãƒã‚§ãƒƒã‚¯ï¼ˆè¨˜éŒ²ã®ãƒªã‚»ãƒƒãƒˆï¼‰
        function checkMidnight() {
            const now = new Date();
            const hours = now.getHours();
            const minutes = now.getMinutes();
            const lastResetDate = localStorage.getItem('lastResetDate');
            const today = now.toDateString();
            
            // 24æ™‚ï¼ˆ0æ™‚ï¼‰ã«ãªã‚Šã€ã¾ã ä»Šæ—¥ãƒªã‚»ãƒƒãƒˆã—ã¦ã„ãªã„å ´åˆ
            if (hours === 0 && minutes === 0 && lastResetDate !== today) {
                console.log('ğŸ•› 24æ™‚ã«ãªã‚Šã¾ã—ãŸã€‚è¨˜éŒ²ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™...');
                
                // è¨˜éŒ²ã‚’å…¨å‰Šé™¤
                records = [];
                saveRecords();
                
                // ãƒªã‚»ãƒƒãƒˆæ—¥ã‚’è¨˜éŒ²
                localStorage.setItem('lastResetDate', today);
                
                console.log('âœ… è¨˜éŒ²ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
            }
        }

        // åˆæœŸåŒ–
        updateDate();
        setInterval(updateDate, 60000); // 1åˆ†ã”ã¨ã«æ—¥ä»˜æ›´æ–°
        setInterval(checkMidnight, 60000); // 1åˆ†ã”ã¨ã«24æ™‚ãƒã‚§ãƒƒã‚¯
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ã‚·ãƒ¼ãƒˆURLè¨­å®šã‚’è¡¨ç¤º
        if (sheetUrl) {
            console.log('Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆé€£æº: æœ‰åŠ¹');
        }

        // ãƒŠã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰é–¢é€£
        let nightModeManual = localStorage.getItem('nightModeManual') === 'true';
        let isNightMode = false;

        function toggleNightMode() {
            nightModeManual = !nightModeManual;
            localStorage.setItem('nightModeManual', nightModeManual);
            applyNightMode();
        }

        function checkAutoNightMode() {
            const hour = new Date().getHours();
            // 23æ™‚ã€œ7æ™‚ã¯è‡ªå‹•ãƒŠã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼ˆæ‰‹å‹•è¨­å®šãŒå„ªå…ˆï¼‰
            return hour >= 23 || hour < 7;
        }

        function applyNightMode() {
            const shouldBeNight = nightModeManual || checkAutoNightMode();
            
            if (shouldBeNight !== isNightMode) {
                isNightMode = shouldBeNight;
                
                if (isNightMode) {
                    document.body.classList.add('night-mode');
                    document.getElementById('nightModeBtn').textContent = 'â˜€ï¸';
                    
                    // ç”»é¢è¼åº¦ã‚’ä¸‹ã’ã‚‹è©¦ã¿ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶åˆ¶é™ã‚ã‚Šï¼‰
                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¼åº¦ã‚’ä¸‹ã’ã‚‹ã‚ˆã†ä¿ƒã™
                    if (!localStorage.getItem('brightnessWarningShown')) {
                        setTimeout(() => {
                            if (confirm('ãƒŠã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ãŒæœ‰åŠ¹ã§ã™ã€‚\n\nã•ã‚‰ã«ç›®ã‚’ä¿è­·ã™ã‚‹ãŸã‚ã€ã‚¹ãƒãƒ›ã®è¼åº¦ã‚’æœ€ä½ã«ã™ã‚‹ã“ã¨ã‚’ãŠã™ã™ã‚ã—ã¾ã™ã€‚\n\nè¨­å®šç”»é¢ã‚’é–‹ãã¾ã™ã‹ï¼Ÿ')) {
                                // Androidã®è¨­å®šã‚’é–‹ãè©¦ã¿
                                window.location.href = 'intent://settings/#Intent;scheme=android-app;package=com.android.settings;end';
                            }
                            localStorage.setItem('brightnessWarningShown', 'true');
                        }, 1000);
                    }
                } else {
                    document.body.classList.remove('night-mode');
                    document.getElementById('nightModeBtn').textContent = 'ğŸŒ™';
                }
            }
        }

        // åˆå›é©ç”¨ã¨å®šæœŸãƒã‚§ãƒƒã‚¯
        applyNightMode();
        setInterval(applyNightMode, 60000); // 1åˆ†ã”ã¨ã«ãƒã‚§ãƒƒã‚¯
    </script>
</body>
</html>
